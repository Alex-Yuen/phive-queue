language: php

php:
    - 5.4
    - 5.5
    - 5.6
    - hhvm
    - hhvm-nightly

matrix:
    allow_failures:
        - php: hhvm
        - php: hhvm-nightly

services:
    - mongodb
    - redis-server

before_install:
    # gearman
    - >
        bash -c 'if [[ $TRAVIS_PHP_VERSION != hhvm* ]]; then
        sudo apt-get install python-software-properties;
        sudo add-apt-repository -y ppa:gearman-developers/ppa;
        fi;'

    # tarantool (http://stable.tarantool.org/download.html)
    - >
        bash -c 'if [[ $TRAVIS_PHP_VERSION != hhvm* ]]; then
        wget http://tarantool.org/dist/public.key;
        sudo apt-key add ./public.key;
        release=`lsb_release -c -s`;
        echo "deb http://tarantool.org/dist/stable/ubuntu/ $release main" | sudo tee -a /etc/apt/sources.list.d/tarantool.list;
        echo "deb-src http://tarantool.org/dist/stable/ubuntu/ $release main" | sudo tee -a /etc/apt/sources.list.d/tarantool.list;
        fi;'

    - sudo apt-get update

install:
    # gearman
    - >
        bash -c 'if [[ $TRAVIS_PHP_VERSION != hhvm* ]]; then
        sudo apt-get install gearman-job-server libgearman-dev;
        pecl install gearman;
        sudo service gearman-job-server stop;
        sudo gearmand -d;
        fi;'

    # tarantool-lts
    - >
        bash -c 'if [[ $TRAVIS_PHP_VERSION != hhvm* ]]; then
        sudo apt-get install tarantool-lts tarantool-lts-client;
        sudo wget https://raw.githubusercontent.com/tarantool/queue/master/init.lua;
        sudo wget https://raw.githubusercontent.com/tarantool/queue/master/tarantool.cfg -O /etc/tarantool/instances.enabled/queue.cfg && echo "script_dir = "`pwd` | sudo tee -a /etc/tarantool/instances.enabled/queue.cfg;
        sudo service tarantool-lts restart;
        fi;'

    #tarantool-php
    - >
        bash -c 'if [[ $TRAVIS_PHP_VERSION != hhvm* ]]; then
        git clone https://github.com/tarantool/tarantool-php.git;
        cd ./tarantool-php;
        git checkout stable;
        phpize;
        ./configure;
        make;
        sudo make install;
        fi;'

    # beanstalk
    - sudo apt-get install -y beanstalkd
    - sudo beanstalkd -d -l 127.0.0.1 -p 11300

    # uopz
    - >
        bash -c 'if [[ $TRAVIS_PHP_VERSION != hhvm* ]]; then
        pecl install uopz;
        fi;'

    # php.ini
    - >
        bash -c 'if [[ $TRAVIS_PHP_VERSION != hhvm* ]]; then
        printf "
        extension = mongo.so\n
        extension = redis.so\n
        extension = tarantool.so\n
        " >> ~/.phpenv/versions/$TRAVIS_PHP_VERSION/etc/php.ini;
        fi;'

    # hhvm-pgsql
    - >
        bash -c 'if [[ $TRAVIS_PHP_VERSION == hhvm* ]]; then
        # http://stackoverflow.com/questions/19386651/how-to-fix-usr-lib-libstdc-so-6-version-glibcxx-3-4-15-not-found/21192519#21192519
        sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test;
        sudo apt-get update;
        sudo apt-get install libstdc++6-4.7-dev;
        wget https://raw.githubusercontent.com/PocketRent/hhvm-pgsql/releases/3.6.0/ubuntu/precise/pgsql.so;
        echo "hhvm.dynamic_extension_path = `pwd`" | sudo tee -a /etc/hhvm/php.ini;
        echo "hhvm.dynamic_extensions[pgsql] = pgsql.so" | sudo tee -a /etc/hhvm/php.ini;
        fi;'

before_script:
    - mysql -e 'create database phive_tests;'
    - psql -c 'create database phive_tests;' -U postgres

    # Mongofill
    - >
        bash -c 'if [[ $TRAVIS_PHP_VERSION == hhvm* ]]; then
        composer require mongofill/mongofill:dev-master;
        fi;'

    - composer install

    # gearman workers
    - >
        bash -c 'if [[ $TRAVIS_PHP_VERSION != hhvm* ]]; then
        (php tests/worker.php >> worker.log &);
        (php tests/worker.php >> worker.log &);
        (php tests/worker.php >> worker.log &);
        (php tests/worker.php >> worker.log &);
        fi;'

script:
    - phpunit -v --coverage-clover coverage.clover

    - >
        bash -c 'if [[ $TRAVIS_PHP_VERSION != hhvm* ]]; then
        phpunit --group concurrency;
        fi;'

after_script:
    - >
        bash -c 'if [[ $TRAVIS_PHP_VERSION != hhvm* ]]; then
        cat worker.log;
        fi;'

    # code-coverage for scrutinizer-ci
    - >
        bash -c 'if [[ $TRAVIS_PHP_VERSION == 5.4 ]]; then
        wget https://scrutinizer-ci.com/ocular.phar;
        php ocular.phar code-coverage:upload --format=php-clover coverage.clover;
        fi;'
